\documentclass[main.tex]{subfiles}

\title{Estimating duration in the presence of misclassification}
\author{Joshua Blake}
\date{\today}

\begin{document}
\maketitle

In this section, we relax the assumption of perfect testing to allow
some false negatives. We use a fairly simplified model to ensure the
likelihood is tractable. This requires modifying both $p_{ia}$ to
allow for the episode possibly being longer than observed, and
$p_{it}$ to allow for additional episodes being missed.

Specifically, we introduce a constant test sensitivity $p_\text{sens}$
such that:
\begin{align}
\prob(y_i(t) = 1) = \begin{cases} p_\text{sens} &b_i \leq t \leq e_i \\ 0 &\text{otherwise.}\end{cases}
\end{align}

In practice, it is likely that the test sensitivity is a function of the
viral load of an individual (the concentration of viral material in the
part of the body being sampled). For this initial attempt at modelling
the sensitivity, we ignore this complication.

\section{Modifying $p_{ia}$} \label{modifying-p_ia}

The idea when modifying $p_{ia}$ is to allow for the negative test
following the last positive to be either a true or false negative. If it
is a true negative, then we have a bound on the length of the episode.
If it is a false negative, then we consider the episode's length
right-censored. The likelihood contribution for an episode is then a
mixture of these two scenarios, with the mixture probability determined
by the test sensitivity.

For tractability, we assume that the tests bounding the start of the
infection ($l_i^{(b)}$ and $r_i^{(b)}$) are true results and hence
$b_i \in [l_i^{(b)}, r_i^{(b)}]$. Furthermore, we consider the tests
only between $r_i^{(b)}$ and $l_i^{(e)}$ inclusive (the positive
tests providing a lower bound on the length of the episode). Denote
these tests by
$t'_i = \{ t \in t_i : r_i^{(b)} \leq t \leq l_i^{(e)} \}$ and their
results by $y_i'$. We know that the test results at times in $t_i'$
are either true positives or false negatives. By definition, the test at
$r_i^{(e)}$ is a false negative if and only if $e_i > r_i^{(e)}$. We
proceed by considering the two cases.

First, if $e_i \leq r_i^{(e)}$. In this case, the test at
$r_i^{(e)}$ is a true negative, as are all other tests not in
$t_i'$, and these occur with probability 1.
\begin{align}
&p(y_i', e_i \leq r_i^{(e)} | b_i, p_\text{sens}, \theta) \\
&= p(y_i', l_i^{(e)} \leq e_i \leq r_i^{(e)} | t_i, b_i, p_\text{sens}, \theta) \\ % &\text{as no false positives}
&= p(y_i' \mid l_i^{(e)} \leq e_i \leq r_i^{(e)}, t_i, b_i, p_\text{sens}, \theta) p(l_i^{(e)} \leq e_i \leq r_i^{(e)} | t_i, b_i, p_\text{sens}, \theta) \\
&= \left( \prod_{t \in t_i'} p_\text{sens}^{y_i(t)} (1 - p_\text{sens})^{(1 - y_i(t))} \right) \left( S_\theta(l_i^{(e)} - b_i - 1) - S_\theta(r_i^{(e)} - b_i - 1) \right)
\end{align}

Second, if $e_i > r_i^{(e)}$. In this case, the test at
$r_i^{(e)}$ is a false negative, occurring with probability
$(1 - p_\text{sens})$, and we have no upper bound on the end of the
infection.
\begin{align}
&p(y_i', e_i > r_i^{(e)} | b_i, p_\text{sens}, \theta) \\
&= p(y_i \mid e_i > r_i^{(e)}, t_i, b_i, p_\text{sens}, \theta) p(e_i > r_i^{(e)} | t_i, b_i, p_\text{sens}, \theta) \\
&= \left( \prod_{t \in t_i'} p_\text{sens}^{y_i(t)} (1 - p_\text{sens})^{(1 - y_i(t))} \right) (1 - p_\text{sens}) S_\theta(r_i^{(e)} - b_i - 1)
\end{align}

Combining the above, the replacement for $p_{ia}$ is:
\begin{align}
p_{ia}'
&= p(y_i' \mid p_\text{sens}, \theta) \\
&= \sum_{b_i = l_i^{(b)}}^{r_i^{(b)}} \left( p(y_i', b_i, e_i \leq r_i^{(e)} \mid p_\text{sens}, \theta) p(y_i', b_i e_i > r_i^{(e)} \mid p_\text{sens}, \theta) \right) p(b_i \mid p_\text{sens}, \theta) \\
&= \left( \prod_{t \in t_i'} p_\text{sens}^{y_i(t)} (1 - p_\text{sens})^{(1 - y_i(t))} \right) \\ & \ \times \sum_{b_i = l_i^{(b)}}^{r_i^{(b)}} \left( S_\theta(l_i^{(e)} - b_i - 1) - S_\theta(r_i^{(e)} - b_i - 1) + (1 - p_\text{sens}) S_\theta(r_i^{(e)} - b_i - 1) \right) p(b_i \mid p_\text{sens}, \theta) \\
&= \left( \prod_{t \in t_i'} p_\text{sens}^{y_i(t)} (1 - p_\text{sens})^{(1 - y_i(t))} \right)\sum_{b_i = l_i^{(b)}}^{r_i^{(b)}} \left( S_\theta(l_i^{(e)} - b_i - 1) - p_\text{sens} S_\theta(r_i^{(e)} - b_i - 1) \right) p(b_i \mid p_\text{sens}, \theta).
\end{align}
Note that if $p_\text{sens} = 1$ then $p_{ia}' = p_{ia}$.

\section{Modifying $p_{it}$} \label{modifying-p_it}

With false negatives, an episode with can be truncated in the following
ways:

\begin{enumerate}
\item
  The episode begins before $\min(t_i)$ (assuming there is a
  negligible probability of a false negative test at this point).
\item
  The duration of the episode is less than $t_{ib_i}^N$. These first
  two mechanisms are how truncation previously occurred, with
  probability $p_{it}$.
\item
  The duration of the episode is at least as long as $t_{it}^N$ but
  less than the time to the second test after $t$, $t_{it}^{2N}$,
  and a false negative episode occurred at the first test after $t$.
  This occurs with probability:
  \begin{math}
    (1 - p_\text{sens})\frac{1}{T} \sum_{b=\min(t_i)}^T \left( S_\theta(t_{ib}^N + 1) - S_\theta(t_{ib}^{2N} + 1)\right).
  \end{math}
\item
  The duration of the episode is at least as long as $t_{it}^{2N}$,
  and all the tests within the episode (at least two) are false
  negatives. We assume this occurs with negligible probability.
\end{enumerate}

Hence, the replacement for $1 - p_{it}$ is:
\begin{align}
1 - p_{it}'
&= 1 - p_{it} - (1 - p_\text{sens})\frac{1}{T} \sum_{b=\min(t_i)}^T \left( S_\theta(t_{ib}^N + 1) - S_\theta(t_{ib}^{2N} + 1)\right) \\
&= \frac{1}{T} \sum_{b=\min(t_i)}^T \left( p_\text{sens} S_\theta(t_{ib}^N + 1) + (1 - p_\text{sens}) S_\theta(t_{ib}^{2N} + 1)\right) \\
\end{align}

\end{document}