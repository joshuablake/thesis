\documentclass[thesis.tex]{subfiles}

\begin{document}
\chapter{Mechanistic modelling of incidence and transmission} \label{SEIR}

Mechanistic models are...

This chapter focuses on mechanistic models based on ordinary differential equations (ODEs).
They are useful because...

Notation in this chapter differs from the rest of the thesis.
I adopt the conventions and notation standard in the infectious disease modelling field.
In particular, upper-case letters denote populations, and lower-case letters denote proportions.
Whether a variable is random or not is explictly stated if not clear from the context.

\Cref{SEIR:sec:transmission} gives the background on ODE-based mechanistic models.
The literature on mechanistic models is vast, going back to at least \textcite{kermackContribution}.
Here, I explain only the background necessary to understand the model used in this chapter.
For further details I recommend the tutorial paper \textcite{kretzschmarMathematical} or the textbook \textcite{keelingModeling}.
\Cref{SEIR:sec:observation} describes the novel observation model that I use for the CIS data.
The model's implementation and fitting is explained in \cref{SEIR:sec:inference-implementation}.
I verify the inference procedure in a simulation study in \cref{SEIR:sec:sim-study} before applying it to the autumn 2020 CIS data in \cref{SEIR:sec:application}.
Finally, \cref{SEIR:sec:discussion} discusses the results, and possible extensions, including those needed to extend to the period including vaccination.

\section{ODE-based compartmental transmission models} \label{SEIR:sec:transmission}

This section first introduces a simple ODE-based model.
ODE-based models are \emph{deterministic}.
Deterministic models have the property that once the parameters are set, there is no randomness in the transmission model.
The transmission model corresponds to the infection process (see \cref{E-inc-prev:sec:infection-process}).
There remains randomness in the observation model (described in \cref{SEIR:sec:observation}).

ODE models are mathematically described by a system of ODEs.
The derivative is taken with respect to time, $t$.
Therefore, in an ODE model, time is necessarily continuous.
However, time is discretised when solving (see \cref{SEIR:sec:inference-implementation})

The number of individuals is also continuous.
This is a reasonable approximation when the population is large.

The other type of model is \emph{stochastic}.
Stochastic models have randomness in the transmission model, and often use discrete time.
For example, the number of individuals infected on day $t+1$, conditional on the model state on day $t$ might be a Poisson distribution.
When the number of infected individuals is large, then deterministic models are a good approximation to stochastic models.
Deterministic models are also known as \emph{mean-field} models because they can be derived from stochastic models by taking the mean of the distribution of the number of infected individuals.
Further discussion of stochastic models is beyond the scope of this thesis.

The class of models considered here is \emph{compartmental} models.
A compartmental model divides all members of the population into compartments, each representing a disease state.
Compartmental models are the most common type of mechanistic infectious disease model.
Compartmental models can be deterministic or stochastic.

\subsection{The SIR model}

The simplest compartmental model is the \emph{susceptible-infected-recovered} (SIR) model.
The name refers to the three compartments in the model.
Individuals in the susceptible compartment can be infected.
Individuals in the infected compartment can infect others, and eventually recover.
Individuals in the recovered compartment are immune to the disease, and cannot be infected again.

The SIR model is described by the following system of ODEs:
\begin{align}
\frac{ds}{dt} &= -\beta si \\
\frac{di}{dt} &= \beta si - \gamma i \\
\frac{dr}{dt} &= \gamma i
\end{align}
$s$, $i$ and $r$ are the proportions of the population in the susceptible, infected and recovered compartments respectively.
These are the state of the system.
The state is a function of time, $t$, although this is not shown explicitly.
Two parameters are present in this model: $\beta$ and $\gamma$.
$\beta$ is the transmission rate, or the number of individuals an infected individual infects per day.
$\gamma$ is the recovery rate, or the proportion of infected individuals that recover per day; hence, $1/\gamma$ is the mean infectious period.
These parameters are assumed to be constant over time (this assumption is relaxed in \cref{SEIR:sec:time-varying-foi}).

The term $\beta si$ is the instantaneous number of individuals infected.
That is, the number of individuals moving from the susceptible state to the infected state.
This term can be arrived at by considering a single infected individual.
Assume this individual makes contact with other individuals in the population at a constant rate.
Further, assume that the population is \emph{well-mixed}, that is that the individual is equally likely to come into contact with any other individual.
Therefore, the probability that the individual comes each of these contacts is a susceptible individual is $s$.
Finally, assume that there is a constant probability of transmission upon contact between an infected and susceptible individual.
The two constant terms here (number of contacts and probability of transmission) are absorbed into the transmission rate, $\beta$.
Therefore, the instantaneous number of infections per infected individual is $\beta s$.
The overall proportion of the population instantaneously infected is $\beta si$.

The term $\gamma i$, the instantaneous number of individuals recovering, follows directly from the definitions of $\gamma$ and $i$.

A few properties of the SIR model are worth noting.
First, the population is closed.
That is, the total population size is constant, and no infections are imported from outside the population.
Births and deaths of individuals are also excluded.
Second, there is no analytical solution to the system of ODEs.
Numerical methods are required to solve the system.
Third, in addition to the parameters, the state of the system at some time (normally the initial state) is required to solve the system.


\subsection{Non-exponential waiting times} \label{SEIR:sec:non-exponential}

The basic SIR model implies that the distribution of the time spent in the infected compartment is exponential.
This is an unrealistic assumption and leads to underestimating the reproduction number~\autocites{lloydRealistic}{wearingAppropriate}.
A standard extension to the SIR model is to allow the infectious period to follow a gamma distribution.
This is done by adding multiple infected compartments.
The system can now be written as follows
\begin{align}
\frac{ds}{dt} &= -\beta si \\
\frac{di_1}{dt} &= \beta si - n\gamma i_1 \\
\frac{di_2}{dt} &= n\gamma i_1 - n \gamma i_2 \\
&\vdots \nonumber \\
\frac{di_n}{dt} &= n\gamma i_{n-1} - n \gamma i_n \\
\frac{dr}{dt} &= n\gamma i_n
\end{align}
where $n$ is the number of infected compartments.
The infectious period is now distributed $\GamDist(n, n\gamma)$.
A gamma distribution with the first paramter equal to 1 is an exponential distribution, connecting this model to the basic SIR model.
$1/\gamma$ remains the mean infectious period because $n\gamma$ is used as the rate of transition between the compartment.

Using a two parameter distribution allows the first two moments of the infectious period to be specified.
This is normally sufficient to give realistic dynamics within a mean-field model.

\subsection{The SEIR model}

The SIR model assumes that individuals are immediately infectious upon infection.
This is unrealistic, as there is a period between infection and infectiousness, known as the \emph{latent period}.
Ignoring the latent period will again overestimate the reproduction number~\autocite{wearingAppropriate}.

The SIR model can be extended to include a latent period by adding a latent compartment.
This is also known as an \emph{exposed} compartment.
Therefore, we now form the susceptible-exposed-infected-recovered (SEIR) model.

Similar to the exponential infectious period, the latent period can be modelled as a gamma distribution by adding multiple latent compartments.
\begin{align}
\frac{ds}{dt} &= -\beta si \\
\frac{de_1}{dt} &= \beta si - m\sigma e_1 \\
\frac{de_2}{dt} &= m\sigma e_1 - m \sigma e_2 \\
&\vdots \nonumber \\
\frac{de_m}{dt} &= m\sigma e_{m-1} - m \sigma e_m \\
\frac{di_1}{dt} &= m\sigma e_m - n\gamma i_1 \\
\frac{di_2}{dt} &= n\gamma i_1 - n \gamma i_2 \\
&\vdots \nonumber \\
\frac{di_n}{dt} &= n\gamma i_{n-1} - n \gamma i_n \\
\frac{dr}{dt} &= n\gamma i_n
\end{align}
where $m$ is the number of latent compartments and $1/\sigma$ is the mean latent period.
The latent period is now distributed $\GamDist(m, m\sigma)$.
The infectious period is still distributed $\GamDist(n, n\gamma)$.


\subsection{Structured populations} \label{SEIR:sec:structured-populations}

\todo[inline]{Introduction about the importance of age and mixing patterns, maybe show a contact matrix}

To allow for age, the population is divided into age groups.
The state of each comparment is now a vector.
The proportion of the population that is susceptible is $\vec{s}$ where $s_i$ is the proportion of the $i$th age group that is susceptible.
Similarly for the other compartments.

The modelling approach here can be used to stratify the population by any charcteristic.
For example, using deprivation or ethnicity.
In this case, $i$ simply represents the $i$th strata.

The assumption of a well-mixed population is relaxed by using a contact matrix.
Now, only conditional on age are all individuals identical.

To incorporate the strata into the model, first I introduce some notation.
denote the set of strata, normally age groups, as $\set{A}$. $N_i$ notates the population in stratum $i$ and hence $s_i N_i$ is the number of susceptible people in stratum $i$.
The other compartments are notated similarly.

We want to derive a matrix $\matr{B}$ which we can use to calculate the instantaneous number of new infections.
We do this by considering a susceptible individual $a$ in stratum $i$.
I use the notation $\rate(X)$ to mean the rate at which the event $X$ occur.
\begin{align}
    &\rate(\text{Individual $a$ infected}) \\
    &\approx \sum_{j \in \set{A}} \rate(\text{Individual $a$ is infected by an individual in stratum $j$}) \\
    &\approx \sum_{j \in \set{A}} \rate(\text{Contacts $a$ has with individuals in stratum $j$}) \\ &\, \times \prob(\text{$a$ infected} \mid \text{contact between $a$ and individual from stratum $j$})\\
    &= \sum_{j \in \set{A}} M_{ij} \beta_{ij} i_j
\end{align}
where $M_{ij}$ is the instantaneous number of contacts an individual in strata $i$ has with individuals in stratum $j$ (assumed homogeneous mixing within strata); and $\beta_{ij}$ is the probability of transmission from an infectious individual in stratum $j$ to a susceptible individual in stratum $i$ given a contact between these individuals.
Note that, unlike previously, here we have explicitly separated out the number of contacts $M_{ij}$ from the probability of transmission $\beta_{ij}$.
The first two approximations are from mass-action dynamics which are valid as long as the transmission probability is small, meaning that we can ignore that the events are not mutually exclusive.
Therefore, the expected rate of new infections in strata $i$ is $s_i N_i \sum_{j \in \set{A}} M_{ij} \beta_{ij} i_j$, which is equivalent to:
\begin{align}
    \frac{d\vec{s}}{dt} = -\vec{s} \circ ((\matr{\beta} \circ \matr{M}) \vec{i})
    \label{eq:matrix:theory}
\end{align}
where $\circ$ is the element-wise product (\ie: $(\matr{A} \circ \matr{B})_{ij} = A_{ij} B_{ij}$).

Clearly $M_{ij}$ and $\beta_{ij}$ are not individually identifiable.
Normally, $M_{ij}$ is assumed to be known.
$\beta_{ij}$ is then estimated, although often with some simplifying assumptions.
These could be that the probability of transmission is independent of age, and therefore all $\beta_{ij}$ are equal.
Alternatively, that each stratum has a relative probability of being infected independent of who is infecting them, and therefore $\beta_{ij} = \beta \beta_j$.

Now, we assume that $\beta_{ij} = \beta(t) \beta_{ij}$ where $\beta(t)$ is a non-strata-specific, time-varying component representing precautions taken by the population, for example masking; and $\beta_{ij}$ represents a constant probability of transmission from an infectious individual in strata $j$ to a susceptible individual in strata $i$ given contact, which could, for instance, be affected by differential susceptibility to infection for different age-groups.
We arbitrarily choose one $\beta_{ij}$ to be equal to 1 for identifiability and hence the other $\beta_{ij}$ values are relative to this reference class.

Based on prior work\todo{cite}, I assume that all individuals have the same \emph{infectiousness} but that there is a difference in \emph{susceptibility}.
Infectiousness is how likely an individual is to infect others.
Susceptibility is how likely an individual is to be infected.
Therefore, $\beta_{ij} = \beta_i$ where $\beta_i$ is the relative susceptibility of stratum $i$.
I assume that the only difference is that children and adults have differing susceptibility.
For identifiability, I set $\beta_i$ to 1 for adults and $\beta_i = \beta_c$ for children.

\subsection{Geographic structure} \label{SEIR:sec:geography}

The well-mixed population assumption is more plausible for smaller scales.
Additionally, due to non-response bias, CIS is not geographically representative.
Therefore, I stratify the population by region.

I assume that each region is a well-mixed population and closed.
A more complex model would allow for interaction between regions.
However, for a large epidemic, non-interacting populations is a good approximation and can even provide better fits~\autocite{birrellRealtimea}.

This is implemented by running the model separately and independently for each region.
England is split into nine regions (previously known as Government Offices for the Regions): South East, London, North West, East of England, West Midlands, South West, Yorkshire and The Humber, East Midlands, and North East.

Each element of the vector $\vec{s}$ refers to the proportion of that region's population of the relevant age group.
The other vectors are interpreted similarly.

\subsection{Time-varying behaviour} \label{SEIR:sec:time-varying-foi}

During the pandemic, behaviour clearly changed over time.
This was in response to government policy, also individual's perceived risk, and a variety of other factors.
I follow \textcite{birrellRealtime}, using a combination of Google moblity data and a time-varying transmission intensity to include these changes.

How between-age-group contacts occur have previously been inferred from a combination of contact surveys, time use data, and mobility data~\autocites{vanleeuwenTime}{vanleeuwenAugmenting}.
I use the outputs from this analysis as $\matr{M}$.
To summarise, baseline rates and contexts of contacts between age groups are taken from the contact survey POLYMOD~\autocite{mossongSocial}.
How these contacts relate to time use is taken from the UK Time Use Survey.
How time use changed over the pandemic is taken from the Google mobility data, which measured the locations of Android users over the period of interest.

Some behavioural changes (\eg mask wearing) are not captured by the contact survey.
To allow for these changes, $\beta$ is allowed to vary over time.
In particular, $\beta$ follows a random walk in log space on the weekly timescale:
\begin{align}
    \beta(t) &= \beta_{w(t)} \\
    \log\beta_{w+1} &= \log\beta_w + \sigma_\epsilon \epsilon_w \\
    \epsilon_w &\sim \N(0, 1)
\end{align}
where $w(t)$ is the week number of time $t$, with week 1 being the first week modelled.
Two parameters are unspecified here: the initial random of the random walk, $\beta_1$, and the standard deviation of the random walk, $\sigma_\epsilon$.
See \cref{perf-test:sec:parameters-priors} for the implementation and parameterisation of these.

\section{Observation model} \label{SEIR:sec:observation}

A variety of different approaches can be taken to link a transmission model to observations.
Here, I extend the system of ODEs to include comparments representing PCR positive individuals.
Whenever an individual is infected, a copy of them is placed in the pre-positive compartment, $p_0$.
These individuals then transition into a set of compartment with their transition rates chosen to match the duration of positivity estimates in \cref{E-imperf-test}, $p_1, \dots, p_l$.
The modelled proportion of individuals that are PCR positive in the can then be linked to the data using a Beta-Binomial likelihood.

I use the method of \textcite{osogamiClosed} to determine $l$ and the transition rates between the compartments.
The class of distributions which can be represented as a series of compartments are known as \emph{phase-type} distributions.

\Textcite{osogamiClosed} define a subset of phase-type distributions which they refer to as Erlang-Coxian (EC) distributions (see following e).
A $l$-phase EC distribution is a convoluation of a $(l-2)$-phase gamma distribution and two-phase acyclic, arbitrary phase-type distribution (with some additional constraints).
The arrival times at the absorbing state (after the final state) is the duration.
Therefore, the absorbing state is the PCR negative state, which does not need to be tracked.

\Textcite{osogamiClosed} prove that EC distributions have the following properties:
\begin{itemize}
    \item Any distribution that can be well-matched (defined as having the same first three moments) by an acyclic phase-type distribution can be well-matched for some $P$ which is an EC distribution.
    \item The number of phases used by $P$ is at most one more than the optimal number.
    \item The parameters of $P$ are available in closed form, and the expression for these is derived.
\end{itemize}

A total of five parameters are required to specify a $l$-phase EC distribution.
\begin{itemize}
    \item $l$, the number of phases.
    \item $\kappa_Y$, the rate parameter of the Erlang distribution.
    \item $\kappa_{X1}$, the rate parameter of the first state after the Erlang distribution.
    \item $\kappa_{X2}$, the rate parameter of the second state after the Erlang distribution.
    \item $p_x$, the probability of moving from the first state after the Erlang distribution to the second (as opposed to directly to the absorbing state).
\end{itemize}
\begin{figure}
\begin{tikzpicture}[
    node distance = 2.5cm,
    on grid,
    auto,
    ->,>=stealth',
    every state/.style={draw,rectangle,very thick},
    ]

    \node[state] (1) {1};
    \node[state, right of=1] (2) {2};
    \node[state, right of=2, draw=none] (dots) {$\dots$};
    \node[state, right of=dots] (lm2) {$l-2$};
    \node[state, right of=lm2] (lm1) {$l-1$};
    \node[state, right of=lm1] (l) {$l$};
    \node[state, right of=l, align=center] (absorbing) {absorbing\\state};

    \path (1) edge node {$\kappa_Y$} (2)
          (2) edge node {$\kappa_Y$} (dots)
          (dots) edge node {$\kappa_Y$} (lm2)
          (lm2) edge node {$\kappa_Y$} (lm1)
          (lm1) edge node {$p_x \kappa_{X1}$} (l)
                edge [out=-45,in=-135] node[below] {$(1 - p_x) \kappa_{X1}$} (absorbing)
          (l) edge node {$\kappa_{X2}$} (absorbing);
\end{tikzpicture}
\caption{A $l$ phase EC distribution.}
\end{figure}


I use the mapfit package~\autocite{mapfit} to compute $P$ for the posterior mean of the distribution estimated in \cref{E-imperf-test}.
The parameter estimates are in \cref{SEIR:table:ec-params}.
\begin{table}
    \centering
    \begin{tabular}{c c c c c}
        $l$ & $\kappa_Y$ & $\kappa_{X1}$ & $\kappa_{X2}$ & $p_x$ \\
        3 & 0.0820 & 0.126 & 0.0223 & 0.00973  \\
    \end{tabular}
    \caption{Parameter estimates for $P$, the EC distribution fit to the posterior mean of the duration distribution estimated in \cref{E-imperf-test}.}
    \label{SEIR:table:ec-params}
\end{table}
% end table of ec params

To link the model with prevalence measurements, I use a beta-binomial likelihood.
If on each day $t$, each strata $i$ is observed to have $y_{it}$ positives out of $n_{it}$ tests on days $t$, then the likelihood is:
\begin{align}
    \prod_{i,t} \BB (y_{it} \mid n_{it}, \sum_{k=1}^l p_{ki}(t), \rho)
\end{align}
using the mean-dispersion parametrisation of the beta-binomial distribution (see \cref{E-distributions}).
$\rho$ is a nuisance parameter controlling the overdispersion of the beta-binomial distribution.
At $\rho=0$, the beta-binomial coincides with the binomial distribution.

\section{Full model} \label{SEIR:sec:full-model}

\begin{figure}
\begin{tikzpicture}[
    node distance = 2.5cm,
    on grid,
    auto,
    ->,>=stealth',
    every state/.style={draw,rectangle,very thick},
    ]

    \node[state] (S) {$s$};
    \node[state, right=of S] (E1) {$e_1$};
    \node[state, right=of E1] (E2) {$e_2$};
    \node[state, right=of E2] (I1) {$i_1$};
    \node[state, right=of I1] (I2) {$i_2$};
    \node[state, right=of I2] (R) {$r$};

    \path (S) edge node {$\sum_j \beta_{ij} i_j$} (E1)
          (E1) edge node {$\sigma$} (E2)
          (E2) edge node {$\sigma$} (I1)
          (I1) edge node {$\gamma$} (I2)
          (I2) edge node {$\gamma$} (R);

    \node[state, below=3cm of E1] (P0) {$p_0$};
    \node[state, right=of P0] (P1) {$p_1$};
    \node[state, right=of P1] (P2) {$p_2$};
    \node[state, right=of P2] (P3) {$p_3$};
    \node[state, right=of P3, draw=none] (P4) {};

    \path  (S) edge node {$\sum_j \beta_{ij} i_j$} (P0)
          (P0) edge node {$\kappa_0$} (P1)
          (P1) edge node {$\kappa_Y$} (P2)
          (P2) edge node {$p_x \kappa_{X1}$} (P3)
               edge [out=-45,in=-135] node[below] {$(1 - p_x) \kappa_{X1}$} (P4)
          (P3) edge node {$\kappa_{X2}$} (P4);
    
    \node[draw, thick, inner sep=0.3cm, fit=(P1) (P3), fill=blue!10,opacity=0.2] {};
\end{tikzpicture}
  \caption[SEIR model]{SEIR model used for the analysis in this chapter. The shaded box represents PCR-positive individuals. Shown for a single strata $i$.}
  \label{SEIR:fig:full-model}
\end{figure}

The full model combines each of the elements discussed in the previous sections.
The transmission model follows \textcite{birrellRealtime}.
It is a SEIR model with two latent and two infectious states (see \cref{SEIR:sec:non-exponential}), producing a gamma distribution.
The population is stratified by age, using contact matrices to  (see \cref{SEIR:sec:structured-populations}).
The force-of-infection and contact matrices changes over time as described in \cref{SEIR:sec:time-varying-foi}.
The population in the model is that of one region of England.
To form whole of England estimates, each region is modelled independently with the results then combined (see \cref{SEIR:sec:geography}).

The observation model is novel, to relate the transmission to CIS data.
It uses a phase-type model to represent the duration distribution of PCR positivity as explained in \cref{SEIR:sec:observation}.

A diagram of the model is shown in figure \cref{SEIR:fig:full-model}.
The system of differential equations is below.
\begin{align}
    \label{SEIR:eq:fullODEs}
    \frac{d\vec{s}}{dt} &= -\vec{\Delta} \\
    \frac{d\vec{e_1}}{dt} &= \vec{\Delta} - 2\sigma \vec{e_1} \\
    \frac{d\vec{e_2}}{dt} &= 2\sigma \vec{e_1} - 2\sigma \vec{e_2} \\
    \frac{d\vec{i_1}}{dt} &= 2\sigma \vec{e_2} - 2\gamma \vec{i_1} \\
    \frac{d\vec{i_2}}{dt} &= 2\gamma \vec{i_1} - 2\gamma \vec{i_2} \\
    \frac{d\vec{r}}{dt} &= 2\gamma \vec{i_2} \\
    \frac{d\vec{p_0}}{dt} &= \vec{\Delta} - \kappa_0 \vec{p_0} \\
    \frac{d\vec{p_1}}{dt} &= \kappa_0 \vec{p_0} - \kappa_Y \vec{p_1} \\
    \frac{d\vec{p_2}}{dt} &= \kappa_Y \vec{p_1} - \kappa_{X1} \vec{p_2} \\
    \frac{d\vec{p_3}}{dt} &= p_x \kappa_{X1} \vec{p_2} - \kappa_{X2} \vec{p_3}
\end{align}
where $\vec{\Delta} = \vec{s} \circ (\matr{\beta} \circ \matr{M}) (\vec{i_1} + \vec{i_2})$ is the vector of instantaneous incidence.


\section{Inference and implementation} \label{SEIR:sec:inference-implementation}

\subsection{MCMC}

I use an adaptive random-walk Metropolis-Hastings algorithm.
The proposal distribution is a multivariate normal that adapts to the covariance of the posterior.
The adaption algorithm is based on \textcite[algorithm 4]{andrieuTutorial}, as implemented in \textcite{ghoshApproximate}.
Proposals are accepted or rejected using the standard Metropolis-Hastings (MH) acceptance probability.
See \cref{SEIR:MCMC-algorithm} for full details.
\begin{algorithm}
 set $\vec{X_0}$ to an initial value of the parameter vector \;
 $\vec{\mu_0} = \vec{X_0}$ \;
 $\matr{\Sigma_0} = \text{diag}(\vec{\mu_0})$ \;
 $\lambda_0 = 1$ \;
 \For{$i = 1, \dots, M$}{
  sample $\vec{Y_}i \sim \N(\vec{\mu_{i-1}}, \lambda_{i-1}\matr{\Sigma_{i-1}})$\;
  set $\vec{X_i}$ to $\vec{Y_i}$ or $\vec{X_{i-1}}$ using a MH acceptance step\;
  update the proportion of proposals accepted so far, $\alpha$ \;
  \eIf(\tcc{No adaptation for 200 iterations}){$i \leq 200$}{
    $\lambda_i = \lambda_{i-1}$ \;
    $\vec{\mu_i} = \vec{\mu_{i-1}}$ \;
    $\matr{\Sigma_i} = \matr{\Sigma_{i-1}}$ \;
   }{
    $\gamma_i = (i - 200)^{-0.6}$ \;
    $\log \lambda_i = \log \lambda_{i-1} + \gamma_i(\alpha - 0.234)$ \;
    $\vec{\mu_i} = (1 - \gamma_i) \vec{\mu_{i-1}} + \gamma_i \vec{X_i}$ \;
    $\matr{\Sigma_i} = (1 - \gamma_i) \matr{\Sigma_{i-1}} + \gamma_i (\vec{X_i} - \vec{\mu_i})(\vec{X_i} - \vec{\mu_i})^T$ \;
  }
 }
 \caption{Algorithm for adaptive random-walk Metropolis-Hastings. $\vec{\mu_i}$ and $\matr{\Sigma_i}$ are the mean and covariance of the proposal distribution at iteration $i$. They adapt to the shape and location of the posterior. $\text{diag}(\vec{\mu_0})$ is the diagonal matrix with diagonal entries equal to $\vec{\mu_0}$. $\lambda_i$ is the scale parameter of the proposal distribution at iteration $i$. $\gamma_i$ is the learning rate, which determines how much adaptation occurs. $\gamma_i \to 0$ as $i \to \infty$ so the rate of adaptation is \emph{vanishing}. Vanishing adaptation is required for the algorithm to converge to the target distribution~\autocite[section 3]{andrieuTutorial}.}
 \label{SEIR:MCMC-algorithm}
\end{algorithm}

\subsection{Parameterisation}

Following \textcite{birrellBayesian}, I reparameterise the model to improve identifiability.
Rather than directly inferring $\beta_1$, I infer the initial growth rate of the epidemic.
I use a parsimonious parameterisation of the initial conditions using the initial proportion of the population that are infected and the initial proportion that are susceptible only.
Both of these rely on an assumption that the epidemic is in the steady-state exponential growth phase at time 0.

For an age-structured model, as the one here, the initial phase of the epidemic, when most individuals are susceptible, is approximately exponential.
In fact, all the $\vec{e}$, $\vec{i}$ and $\vec{p}$ compartments grow at the same initial exponential growth rate, $\psi$.
The basic reproduction number, $\R$ of the epidemic is related to this growth rate as follows~\autocites{birrellRealtimea}{wearingAppropriate}:
\begin{align}
    \R = \frac{\psi \left( \frac{\psi}{2\sigma} + 1 \right)^2}{\gamma \left(1 - \frac{1}{\left(\frac{\psi}{2 \gamma} + 1 \right)^2} \right)} \label{SEIR:eq:rtoR}.
\end{align}

$\R$ can be linked to $\beta_1$ because $\R$ is also equal to the dominant eigenvalue of the next-generation matrix, $\matr{G} = \matr\beta \circ \matr{M}$~\autocites{diekmannDefinition}{birrellRealtimea}.
Therefore, the following procedure finds $\beta_1$ such that the growth rate $\psi$ is achieved.
First calculate $\R$ from the model parameters using \cref{SEIR:eq:rtoR}.
Denote this $\hat{R}$.
Then calculate $R^* = D(\matr{G})$ when $\beta_1=1$, where $D(\cdot)$ gives the dominant eigenvalue.
Note that multiplying a matrix by a scalar multiplies its eigenvalues by that same scalar.
Finally, set $\beta_1 = \hat{R} / R^*$.

To form a parsimonious parameterisation of the initial state, first focus on the initial number of infected individuals.
In steady-state exponential growth, the relative proportion of each strata that is infected is proportional to the dominant eigenvector of $\matr{G}$, $\vec{d}$.
I assume this is the case at time 0.
Let the proportion of the population in the $i$ states at time 0 in the strata with the highest proportion infected, $i^+$, be a model parameter.
Then, $\vec{i_0} = \vec{i_1} + \vec{i_2} = \frac{i^+}{\max \vec{d}} \vec{d}$.
I introduce an additional vector of parameters, $\vec{\pi}$, where $\pi_i$ is the proportion of strata $i$ without immunity at time 0.
That is, at time 0, $\vec{r} = 1 - \vec{\pi}$.

The system of ODEs and the result that all the comparments are growing at the same rate give the following for the initial state of the compartments:
\begin{align}
    \vec{i_1} &= \vec{i_0} \left(1 + \frac{2\gamma}{\psi + 2\gamma} \right)^{-1} \\
    \vec{i_2} &= \vec{i_0} - \vec{i_1} \\
    \vec{e_2} &= \vec{i_1} \frac{\psi + 2\gamma}{2\sigma} \\
    \vec{e_1} &= \vec{e_2} \frac{\psi + 2\sigma}{2\sigma} \\
    \vec{s} &= \vec{\pi} - \vec{i_0} - \vec{e_1} - \vec{e_2} \\
    \vec{p_0} &= \vec{e_1} \frac{\psi + 2\sigma}{\psi + \kappa_0} \\
    \vec{p_1} &= \vec{p_0} \frac{\kappa_0}{\psi + \kappa_Y} \\
    \vec{p_2} &= \vec{p_1} \frac{\kappa_Y}{\psi + \kappa_{X1}} \\
    \vec{p_3} &= \vec{p_2} \frac{p_x \kappa_{X1}}{\psi + \kappa_{X2}}.
\end{align}

\subsection{Priors}
The priors for most parameters are shown in \cref{SEIR:table:priors}.
The parameters governing the duration of positivity ($\kappa$s) were explained previous (see \cref{SEIR:table:ec-params}).

\begin{landscape}
\begin{table}
\begin{tabular}{l c l l}
    Parameter description & Symbol & Distribution & Comment \\
    \hline \\
    Mean latent period & $1/\sigma$ & 3.5 days (fixed) & From a paper \\
    Mean infectious period & $1/\gamma$ & 3.5 days (fixed) & From a paper \\
    Initial proportion without immunity & $\pi$ & See \cref{SEIR:table:immunity} & \\
    Initial proportion infected & $i^+$ & $\BetaDist(0.5, 1000)$ & Weakly informative \\
    Relative susceptibility of children & $\beta_c$ & $\LN(-4.325, 0.1174)$ &  \\
    Initial growth rate & $\psi$ & $\N(0.048, 0.0035)$ & Weakly informative, centered on growth rate of deaths \\
    Standard deviation of random walk & $\sigma$ & $\Exponential(80)$ & Weakly informative, NCP \\
    Overdispersion of observations & $\rho$ & $\Exponential(2 \times 10^5)$ & Weakly informative

\end{tabular}
\todo[inline]{Find citation for children, check growth rate, check what NCP is}
\caption[SEIR model priors]{Priors for each parameter. For details of the distributions and their parameterisations see \cref{E-distributions}.}
\label{SEIR:table:priors}
\end{table}
\end{landscape}

\subsection{Solving the systems of ODEs}

\section{Simulation study} \label{SEIR:sec:sim-study}

\section{Application to CIS data} \label{SEIR:sec:application}

\section{Discussion} \label{SEIR:sec:discussion}

\section{Conclusion}

\end{document}